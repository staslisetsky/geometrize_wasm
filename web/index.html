<!doctype html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <link href="https://fonts.googleapis.com/css?family=PT+Sans|PT+Sans+Caption:700" rel="stylesheet">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>geometrize wasm</title>
</head>
<body id="body" style="background:#222; color:#eee; padding:30px;">
  <input type="file" name="max-mutations" id="photo" />
  <input type="button" value="step" id="step">
  <input type="button" value="get json" id="get-json">
  <script async type="text/javascript" src="main.js"></script>
</body>

<script type="text/javascript">
  var image_w = 0;
  var image_h = 0;

  var fileInput = document.getElementById('photo');
  var buttonJson = document.getElementById('get-json');
  var buttonStep = document.getElementById('step');

  function wasmLoadedCallback() {
    // called when all the wasm stuff is ready
    // all Module calls must be only used after this callback is called
    console.log('wasm runtime initialized');
  }

  function stepCompletedCallback() {
    // called when worker thread completes the step and exits
    console.log('step done');
  }

  buttonJson.addEventListener('click', (event) => {
    var result = UTF8ToString(Module._GeometrizeGetFullResultJson());
    // var result = UTF8ToString(Module._GeometrizeGetStepResultJson());
    console.log(result);
  });

  buttonStep.addEventListener('click', (event) => {
    Module._GeometrizeStep();
  });

  function geometrizeImage(file) {
    if(!(file instanceof Blob)) return;

    var reader = new FileReader();
    var reader2 = new FileReader();

    reader.readAsDataURL(file);

    reader.onloadend = event => {
      var image = new Image;
      image.src = reader.result;

      image.onload = function() {
        image_w = image.width;
        image_h = image.height;
        reader2.readAsArrayBuffer(file);
      };
    }

    reader2.onloadend = event => {
      const blobArray = new Uint8Array(event.target.result);
      const data = window.Module._malloc(blobArray.length);

      Module.HEAPU8.set(blobArray, data);

      var maxShapes = 256;
      var maxMutations = 100;
      var alpha = 128;

      Module._GeometrizeLoadImage(data, blobArray.length, maxShapes, maxMutations, alpha);
    }
  }

  fileInput.addEventListener('change', (event) => {
    geometrizeImage(fileInput.files[0]);
  });
</script>
</html>


